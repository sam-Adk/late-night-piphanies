<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Late Night Epiphanies — Art Shop</title>
  <link rel="icon" type="image/x-icon" href="assets/favicon-16x16.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600..900&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  /* CART DRAWER STYLING */
  .cart-drawer { /* ... your original styles ... */ }

  :root {
    --bg-1: #05030a;
    --bg-2: #0c0a1a;
    --card: rgba(255, 255, 255, 0.06);
    --card-strong: rgba(255, 255, 255, 0.12);
    --text: #e7e7f0;
    --muted: #b8b7c7;
    --accent: #8b5cf6;
    --accent-2: #00e5ff;
    --danger: #ff4d6d;
    --success: #22c55e;
    --shadow: 0 10px 30px rgba(0, 0, 0, 0.55);
    --radius: 20px;
  }

  /* ... all your existing CSS ... */

  /* M-PESA BUTTON */
  .btn-success {
    background: linear-gradient(90deg, #00B140, #009933);
    color: white;
    font-weight: 700;
    border: none;
    margin-top: 8px;
  }
  .btn-success:hover {
    background: linear-gradient(90deg, #00C150, #00A033);
  }
</style>
</head>
<body>
  <!-- NAVBAR -->
  <nav class="nav">
    <div class="nav-inner container">
      <div class="brand">
        <div class="logo">Late Night Epiphanies</div>
        <small>midnight sketches & dreamy Art by sam</small>
      </div>
      <div class="nav-actions">
        <button id="commissionBtn" class="glass-btn" title="Commission an artwork">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12.5 7l4.5 4.5M3 21l3.9-1.1c.5-.1 1.0-.4 1.4-.8L20 7.5a2.1 2.1 0 000-3 2.1 2.1 0 00-3 0L5.3 16.1c-.4.4-.7.9-.8 1.4L3 21z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Commission
        </button>
        <button id="cartBtn" class="glass-btn" title="Open cart">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 6h13l-1.3 8.4a2 2 0 01-2 1.6H9.1a2 2 0 01-2-1.6L6 6zm0 0L5 3H3" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="9" cy="20" r="1.5" fill="currentColor"/><circle cx="17" cy="20" r="1.5" fill="currentColor"/></svg>
          Cart <span id="cartCount" style="margin-left:6px;opacity:.8">0</span>
        </button>
      </div>
    </div>
  </nav>

  <!-- HERO -->
  <header class="hero container">
    <div class="hero-content">
      <div>
        <h1>Art that feels like <span>3AM epiphanies</span>.</h1>
        <p>Original pencil sketches and dreamy Art By samuel Adikah, crafted in late‑night quiet. Shop ready‑to‑hang pieces or request a custom portrait.</p>
        <div class="cta-row">
          <a href="#gallery" class="btn btn-primary">Shop Originals</a>
          <button id="heroCommission" class="btn btn-ghost">Request a Commission</button>
        </div>
      </div>
      <div class="hero-card">
        <div class="hero-burst"></div>
        <div class="hero-art">
          <img id="heroImage" alt="Featured midnight sketch"/>
        </div>
      </div>
    </div>
  </header>

  <!-- TOOLBAR -->
  <div class="container">
    <div class="toolbar" role="region" aria-label="Filters">
      <div class="chip active" data-filter="all">All</div>
      <div class="chip" data-filter="Sketch">Sketch</div>
      <div class="chip" data-filter="Portrait">Portrait</div>
      <div class="chip" data-filter="Abstract">Abstract</div>
      <div class="spacer"></div>
      <div class="field" role="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="1.6"/><path d="M20 20l-3.5-3.5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
        <input id="search" type="search" placeholder="Search titles, tags" />
      </div>
      <select id="sort" class="select" aria-label="Sort">
        <option value="default">Sort: Featured</option>
        <option value="price-asc">Price: Low to High</option>
        <option value="price-desc">Price: High to Low</option>
      </select>
    </div>
  </div>

  <!-- GALLERY -->
  <main id="gallery" class="gallery container" aria-live="polite"></main>

  <!-- QUICK VIEW MODAL -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Artwork details">
      <div class="modal-head">
        <strong id="qvTitle">Artwork</strong>
        <button class="x" id="qvClose" aria-label="Close">X</button>
      </div>
      <div class="modal-body">
        <div class="modal-img"><img id="qvImg" alt="Artwork large view"/></div>
        <div>
          <div class="muted" id="qvCat"></div>
          <div style="margin:8px 0 10px" id="qvDesc"></div>
          <div class="opt">
            <label>Size</label>
            <div class="row" id="sizeRow"></div>
          </div>
          <div class="opt">
            <label>Finish</label>
            <div class="row" id="finishRow"></div>
          </div>
          <div class="price" id="qvPrice">KSh 0</div>
          <div class="actions">
            <button class="btn-small" id="saveFav">Wishlist</button>
            <button class="btn-small primary" id="qvAdd">Add to cart</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- CART DRAWER -->
  <aside id="drawer" class="drawer" aria-label="Shopping cart">
    <div class="top">
      <strong>Cart</strong>
      <button class="x" id="cartClose" aria-label="Close">X</button>
    </div>
    <div class="cart-list" id="cartList"></div>
    <div class="bottom">
      <div style="display:flex; justify-content:space-between; align-items:center">
        <span class="muted">Subtotal</span>
        <strong id="subtotal">KSh 0</strong>
      </div>

      <!-- EMAIL CHECKOUT -->
      <button class="btn btn-primary" id="checkoutBtn">Checkout via Email</button>

      <!-- M-PESA BUTTON -->
      <button class="btn btn-success" id="mpesaPayBtn">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="margin-right:6px">
          <path d="M12 2L2 7v10c0 5.55 4.48 8.78 10 12 5.52-3.22 10-6.45 10-12V7l-10-5z" fill="#00B140"/>
        </svg>
        Pay with M-Pesa (Sandbox)
      </button>

      <small class="muted">Secure checkout. We’ll confirm via WhatsApp/Email.</small>
    </div>
  </aside>

  <!-- M-PESA PHONE MODAL -->
  <div id="mpesaModal" class="overlay" style="display:none; place-items:center; z-index:999">
    <div class="modal" style="width:90%; max-width:360px; padding:20px">
      <div class="modal-head" style="margin-bottom:16px; border:none">
        <strong>Enter Phone Number</strong>
        <button class="x" id="mpesaModalClose">X</button>
      </div>
      <form id="mpesaForm">
        <input 
          type="tel" 
          id="mpesaPhone" 
          placeholder="254712345678" 
          required 
          pattern="254[7-9][0-9]{8}"
          style="width:100%; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.2); background:rgba(255,255,255,.05); color:var(--text); font-size:16px"
        />
        <small style="display:block; margin:8px 0; color:var(--muted)">
          Use 2547XXXXXXXX (e.g. 254708374149)
        </small>
        <button type="submit" class="btn btn-primary" style="width:100%; margin-top:8px">
          Send STK Push
        </button>
      </form>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <footer class="container">
    © <span id="year"></span> Late Night Epiphanies — by Samuel Adikah. All rights reserved.
  </footer>

  <script>
    const products = [
      { id: 'p1', title: 'Love Dream I', category: 'Portrait', tags: ['romance', 'bw'], priceBase: 4200, img: 'assets/images/love5.jpg', desc: 'Romantic midnight sketch in pencil.' },
      { id: 'p2', title: 'Love Dream II', category: 'Sketch', tags: ['dreamy', 'soft'], priceBase: 2500, img: 'assets/images/NATURE ART6.jpg', desc: 'A dreamy late-night drawing, soft and textured.' },
      { id: 'p3', title: 'Love Dream III', category: 'Abstract', tags: ['surreal', 'thoughts'], priceBase: 5200, img: 'assets/images/NATURE ART4.jpg', desc: 'Surreal abstraction inspired by late-night epiphanies.' },
      { id: 'p4', title: 'Love Dream IV', category: 'Sketch', tags: ['raw', 'expressive'], priceBase: 3000, img: 'assets/images/NATURE ART5.jpg', desc: 'Expressive raw strokes, part of the Love series.' },
      { id: 'p5', title: 'Love Dream I', category: 'Portrait', tags: ['romance', 'bw'], priceBase: 4200, img: 'assets/images/NATURE ART2.jpg', desc: 'Romantic midnight sketch in pencil.' },
      { id: 'p6', title: 'Love Dream II', category: 'Sketch', tags: ['dreamy', 'soft'], priceBase: 2500, img: 'assets/images/NATURE ART3.jpg', desc: 'A dreamy late-night drawing, soft and textured.' }
    ];

    function svgPlaceholder(title) {
      const grad1 = '#0aefff', grad2 = '#8b5cf6';
      const svg = `<?xml version='1.0' encoding='UTF-8'?>
        <svg xmlns='http://www.w3.org/2000/svg' width='900' height='1125'>
          <defs>
            <linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
              <stop offset='0%' stop-color='${grad1}' stop-opacity='0.55'/>
              <stop offset='100%' stop-color='${grad2}' stop-opacity='0.55'/>
            </linearGradient>
          </defs>
          <rect width='100%' height='100%' fill='black'/>
          <rect x='20' y='20' width='860' height='1085' rx='24' ry='24' fill='url(#g)' opacity='0.35'/>
          <g font-family='Poppins' font-size='54' fill='white' opacity='0.9'>
            <text x='50' y='150'>Late Night Epiphanies</text>
          </g>
          <g font-family='Poppins' font-size='64' fill='white' opacity='0.95'>
            <text x='50' y='600'>${title.replace(/&/g, '&amp;')}</text>
          </g>
          <g fill='white' opacity='.22'>
            <circle cx='750' cy='200' r='6'/>
            <circle cx='820' cy='280' r='4'/>
            <circle cx='820' cy='900' r='5'/>
          </g>
        </svg>`;
      return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
    }

    const KES = v => `KSh ${v.toLocaleString('en-KE')}`;
    const cart = JSON.parse(localStorage.getItem('lnp_cart') || '[]');
    const saveCart = () => localStorage.setItem('lnp_cart', JSON.stringify(cart));
    const favs = new Set(JSON.parse(localStorage.getItem('lnp_favs') || '[]'));
    const saveFavs = () => localStorage.setItem('lnp_favs', JSON.stringify(Array.from(favs)));
    let currentProduct = null;
    let currentSize = 'A4';
    let currentFinish = 'Unframed';

    function sizePriceDelta(size) {
      return { A5: 0, A4: 0, A3: 1200, A2: 2900 }[size] || 0;
    }
    function finishPriceDelta(f) {
      return { Unframed: 0, Framed: 1800 }[f] || 0;
    }
    function computePrice(p) {
      return p.priceBase + sizePriceDelta(currentSize) + finishPriceDelta(currentFinish);
    }

    const gallery = document.getElementById('gallery');
    const heroImage = document.getElementById('heroImage');

    function renderProducts(list) {
      gallery.innerHTML = '';
      list.forEach(p => {
        const card = document.createElement('article');
        card.className = 'card';
        card.innerHTML = `
          <div class='img-wrap'>
            <img alt='${p.title}' src='${p.img || svgPlaceholder(p.title)}' loading='lazy'>
            <div class='tag-badge'>${p.category}</div>
          </div>
          <div class='card-body'>
            <div class='title'>${p.title}</div>
            <div class='muted'>${p.tags.map(t => `#${t}`).join(' ')}</div>
            <div class='price'>${KES(p.priceBase)}</div>
            <div class='actions'>
              <button class='btn-small' data-action='view' data-id='${p.id}'>Quick view</button>
              <button class='btn-small primary' data-action='add' data-id='${p.id}'>Add to cart</button>
            </div>
          </div>`;
        gallery.appendChild(card);
      });
      if (list[0]) heroImage.src = list[0].img || svgPlaceholder(list[0].title);
    }

    const chips = document.querySelectorAll('.chip');
    const search = document.getElementById('search');
    const sort = document.getElementById('sort');

    function applyFilters() {
      const active = document.querySelector('.chip.active').dataset.filter;
      const q = search.value.trim().toLowerCase();
      let list = products.filter(p => active === 'all' ? true : p.category === active);
      if (q) {
        list = list.filter(p => (p.title + ' ' + p.tags.join(' ')).toLowerCase().includes(q));
      }
      if (sort.value === 'price-asc') list.sort((a, b) => a.priceBase - b.priceBase);
      if (sort.value === 'price-desc') list.sort((a, b) => b.priceBase - a.priceBase);
      renderProducts(list);
    }

    chips.forEach(c => c.addEventListener('click', () => {
      chips.forEach(x => x.classList.remove('active'));
      c.classList.add('active');
      applyFilters();
    }));
    search.addEventListener('input', applyFilters);
    sort.addEventListener('change', applyFilters);

    const overlay = document.getElementById('overlay');
    const qvImg = document.getElementById('qvImg');
    const qvTitle = document.getElementById('qvTitle');
    const qvCat = document.getElementById('qvCat');
    const qvDesc = document.getElementById('qvDesc');
    const qvPrice = document.getElementById('qvPrice');
    const qvClose = document.getElementById('qvClose');
    const sizeRow = document.getElementById('sizeRow');
    const finishRow = document.getElementById('finishRow');
    const qvAdd = document.getElementById('qvAdd');
    const saveFav = document.getElementById('saveFav');

    function openQV(p) {
      currentProduct = p;
      currentSize = 'A4';
      currentFinish = 'Unframed';
      qvImg.src = p.img || svgPlaceholder(p.title);
      qvTitle.textContent = p.title;
      qvCat.textContent = p.category;
      qvDesc.textContent = p.desc;
      buildOptions();
      qvPrice.textContent = KES(computePrice(p));
      overlay.style.display = 'grid';
      overlay.setAttribute('aria-hidden', 'false');
    }
    function closeQV() {
      overlay.style.display = 'none';
      overlay.setAttribute('aria-hidden', 'true');
    }
    qvClose.addEventListener('click', closeQV);
    overlay.addEventListener('click', e => {
      if (e.target === overlay) closeQV();
    });

    function optChip(val, group, isActive = false) {
      const el = document.createElement('button');
      el.type = 'button';
      el.className = 'radio' + (isActive ? ' active' : '');
      el.textContent = val;
      el.setAttribute('data-group', group);
      el.addEventListener('click', () => {
        document.querySelectorAll(`.radio[data-group='${group}']`).forEach(r => r.classList.remove('active'));
        el.classList.add('active');
        if (group === 'size') currentSize = val; else currentFinish = val;
        qvPrice.textContent = KES(computePrice(currentProduct));
      });
      return el;
    }
    function buildOptions() {
      sizeRow.innerHTML = '';
      finishRow.innerHTML = '';
      ['A5', 'A4', 'A3', 'A2'].forEach(s => sizeRow.appendChild(optChip(s, 'size', s === 'A4')));
      ['Unframed', 'Framed'].forEach(f => finishRow.appendChild(optChip(f, 'finish', f === 'Unframed')));
    }

    gallery.addEventListener('click', e => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const id = btn.dataset.id;
      const p = products.find(x => x.id === id);
      if (btn.dataset.action === 'view') openQV(p);
      if (btn.dataset.action === 'add') {
        addToCart(p, 'A4', 'Unframed');
        toast('Added to cart');
      }
    });

    qvAdd.addEventListener('click', () => {
      if (currentProduct) {
        addToCart(currentProduct, currentSize, currentFinish);
        closeQV();
        toast('Added to cart');
      }
    });

    saveFav.addEventListener('click', () => {
      if (!currentProduct) return;
      if (favs.has(currentProduct.id)) favs.delete(currentProduct.id); else favs.add(currentProduct.id);
      saveFavs();
      toast(favs.has(currentProduct.id) ? 'Saved to wishlist' : 'Removed from wishlist');
    });

    const cartBtn = document.getElementById('cartBtn');
    const drawer = document.getElementById('drawer');
    const cartClose = document.getElementById('cartClose');
    const cartList = document.getElementById('cartList');
    const subtotalEl = document.getElementById('subtotal');
    const cartCount = document.getElementById('cartCount');

    function openCart() {
      drawer.classList.add('open');
    }
    function closeCart() {
      drawer.classList.remove('open');
    }
    cartBtn.addEventListener('click', openCart);
    cartClose.addEventListener('click', closeCart);

    function addToCart(p, size = 'A4', finish = 'Unframed') {
      const key = `${p.id}-${size}-${finish}`;
      const existing = cart.find(i => i.key === key);
      if (existing) existing.qty += 1;
      else cart.push({ key, id: p.id, title: p.title, size, finish, price: p.priceBase + sizePriceDelta(size) + finishPriceDelta(finish), img: p.img || svgPlaceholder(p.title), qty: 1 });
      saveCart();
      renderCart();
    }

    function changeQty(key, delta) {
      const i = cart.find(x => x.key === key);
      if (!i) return;
      i.qty += delta;
      if (i.qty <= 0) cart.splice(cart.indexOf(i), 1);
      saveCart();
      renderCart();
    }

    function renderCart() {
      cartList.innerHTML = '';
      let subtotal = 0, count = 0;
      cart.forEach(i => {
        subtotal += i.price * i.qty;
        count += i.qty;
        const row = document.createElement('div');
        row.className = 'cart-item';
        row.innerHTML = `
          <img src='${i.img}' alt='' style='width:64px;height:64px;object-fit:cover;border-radius:10px;border:1px solid rgba(255,255,255,.1)'>
          <div>
            <div style='font-weight:600'>${i.title}</div>
            <div class='muted' style='font-size:12px'>${i.size} · ${i.finish}</div>
            <div style='font-weight:700'>${KES(i.price)}</div>
          </div>
          <div class='qty'>
            <button aria-label='Decrease' data-k='${i.key}' data-d='-1'>−</button>
            <span>${i.qty}</span>
            <button aria-label='Increase' data-k='${i.key}' data-d='1'>+</button>
          </div>`;
        cartList.appendChild(row);
      });
      subtotalEl.textContent = KES(subtotal);
      cartCount.textContent = count;
    }

    cartList.addEventListener('click', e => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const key = btn.dataset.k;
      const d = parseInt(btn.dataset.d, 10);
      changeQty(key, d);
    });

    document.getElementById('checkoutBtn').addEventListener('click', () => {
      if (cart.length === 0) {
        toast('Your cart is empty');
        return;
      }
      const summary = cart.map(i => `${i.qty}× ${i.title} (${i.size}, ${i.finish}) — ${KES(i.price * i.qty)}`).join('%0A');
      const total = subtotalEl.textContent.replace(/\s/g, '');
      const msg = `Hello Samuel,%0A%0AI would like to order:%0A${summary}%0A%0ASubtotal: ${total}%0A%0AMy contacts:%0AName:%0APhone (WhatsApp):%0AEmail:%0ADelivery location:`;
      window.location.href = `mailto:samuel@example.com?subject=Order — Late Night Epiphanies&body=${msg}`;
      toast('Opening your email app to place the order');
    });

    const commissionBtn = document.getElementById('commissionBtn');
    const heroCommission = document.getElementById('heroCommission');
    [commissionBtn, heroCommission].forEach(b => b.addEventListener('click', () => {
      const body = encodeURIComponent(`Hello Samuel,%0A%0AI'd like to commission a custom piece.%0A%0AIdea/Subject:%0ASize (A4/A3/A2):%0ADeadline:%0ABudget:%0AReferences: (links)`);
      window.location.href = `mailto:samuel@example.com?subject=Commission Request — Late Night Epiphanies&body=${body}`;
    }));

    const toastEl = document.getElementById('toast');
    function toast(text) {
      toastEl.textContent = text;
      toastEl.classList.add('show');
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(() => toastEl.classList.remove('show'), 2100);
    }

    document.getElementById('year').textContent = new Date().getFullYear();
    renderProducts(products);
    renderCart();
    applyFilters();

    // === M-PESA SANDBOX FLOW ===
    const mpesaPayBtn = document.getElementById('mpesaPayBtn');
    const mpesaModal = document.getElementById('mpesaModal');
    const mpesaModalClose = document.getElementById('mpesaModalClose');
    const mpesaForm = document.getElementById('mpesaForm');
    const mpesaPhone = document.getElementById('mpesaPhone');

    mpesaPayBtn.addEventListener('click', () => {
      const total = parseInt(subtotalEl.textContent.replace(/[^\d]/g, ''), 10);
      if (total === 0) {
        toast('Your cart is empty');
        return;
      }
      mpesaModal.style.display = 'grid';
    });

    mpesaModalClose.addEventListener('click', () => mpesaModal.style.display = 'none');
    mpesaModal.addEventListener('click', (e) => {
      if (e.target === mpesaModal) mpesaModal.style.display = 'none';
    });

    mpesaForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const phone = mpesaPhone.value.trim();
      const amount = parseInt(subtotalEl.textContent.replace(/[^\d]/g, ''), 10);

      if (!/^254[7-9][0-9]{8}$/.test(phone)) {
        toast('Invalid phone. Use 2547XXXXXXXX');
        return;
      }

      mpesaPayBtn.disabled = true;
      mpesaPayBtn.textContent = 'Sending...';

      try {
        const res = await fetch('https://YOUR-BACKEND.onrender.com/api/pay', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone, amount })
        });

        const data = await res.json();
        if (data.success) {
          toast('STK Push sent! Check your phone.');
          mpesaModal.style.display = 'none';
        } else {
          toast(data.error || 'Payment failed');
        }
      } catch (err) {
        toast('Network error. Try again.');
      } finally {
        mpesaPayBtn.disabled = false;
        mpesaPayBtn.innerHTML = `
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="margin-right:6px">
            <path d="M12 2L2 7v10c0 5.55 4.48 8.78 10 12 5.52-3.22 10-6.45 10-12V7l-10-5z" fill="#00B140"/>
          </svg>
          Pay with M-Pesa (Sandbox)
        `;
      }
    });
  </script>
</body>
</html>
